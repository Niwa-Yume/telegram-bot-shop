<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>CBD Shop ¬∑ Catalogue</title>
  <style>
    /* ===== Design System ===== */
    :root{
      --bg:#0a0a0f; --surface:#12131a; --surface-hover:#181925; --card:#15161f;
      --text:#f8f9fa; --muted:#8b92a7; --border:#1e1f2e;
      --accent:#24cfff; --accent-alt:#0079ff;
      --accent-grad:linear-gradient(135deg,var(--accent) 0%,var(--accent-alt) 100%);
      --success:#4ade80; --warning:#fbbf24; --danger:#f87171;
      --radius:12px; --radius-sm:8px; --shadow: 0 4px 24px rgba(0,0,0,0.4);
      --transition: all 0.2s ease;
    }

    /* Base Reset */
    *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      background: var(--bg); color: var(--text);
      font: 14px/1.5 -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0; min-height: 100vh; padding-bottom: 20px;
    }

    /* ===== Layout Views ===== */
    #publicInterface, #adminInterface, #loginScreen { display: none; }
    .view-active { display: block !important; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ===== Header Global ===== */
    header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(18, 19, 26, 0.95);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .header-inner {
      padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
      max-width: 1000px; margin: 0 auto;
    }
    .logo { font-size: 18px; font-weight: 800; background: var(--accent-grad); -webkit-background-clip: text; color: transparent; }

    /* ===== Mobile Nav / Filters (SCROLLABLE) ===== */
    .category-nav {
      position: sticky; top: 53px; /* Juste sous le header */
      z-index: 90;
      background: rgba(10, 10, 15, 0.95);
      border-bottom: 1px solid var(--border);
      padding: 10px 16px;
      display: flex; gap: 10px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch; /* Scroll fluide iOS */
      scrollbar-width: none; /* Cache scrollbar Firefox */
    }
    .category-nav::-webkit-scrollbar { display: none; } /* Cache scrollbar Chrome/Safari */

    .cat-pill {
      flex-shrink: 0;
      padding: 6px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--muted);
      font-size: 13px; font-weight: 600;
      cursor: pointer; transition: var(--transition);
    }
    .cat-pill.active {
      background: var(--accent); color: #fff; border-color: var(--accent);
      box-shadow: 0 2px 10px rgba(36, 207, 255, 0.3);
    }

    /* ===== Shop Grid (Mobile optimized) ===== */
    .shop-container { max-width: 1000px; margin: 0 auto; padding: 16px; }

    /* Affichage grille responsive : 2 colonnes sur mobile, plus sur desktop */
    .shop-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (min-width: 600px) { .shop-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; } }

    .shop-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); overflow: hidden;
      display: flex; flex-direction: column;
    }
    .card-media {
      aspect-ratio: 1; /* Carr√© parfait */
      background: #000; position: relative; overflow: hidden;
    }
    .card-media img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
    .card-info { padding: 12px; flex: 1; display: flex; flex-direction: column; }
    .card-cat { font-size: 10px; text-transform: uppercase; color: var(--accent); font-weight: 700; margin-bottom: 4px; }
    .card-title { font-size: 14px; margin: 0 0 4px; font-weight: 600; line-height: 1.3; }
    .card-farm { font-size: 11px; color: var(--muted); margin-bottom: 8px; }
    .card-price { margin-top: auto; font-size: 15px; font-weight: 700; color: #fff; }

    /* ===== Buttons ===== */
    .btn {
      padding: 8px 14px; border: 1px solid var(--border); border-radius: 8px;
      background: var(--card); color: white; font-size: 13px; font-weight: 600;
      cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn.danger { background: rgba(248, 113, 113, 0.2); border-color: var(--danger); color: var(--danger); }
    .btn.small { padding: 6px 10px; font-size: 12px; }

    /* ===== Login Modal ===== */
    #loginScreen {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000;
      display: none; align-items: center; justify-content: center; padding: 20px;
    }
    #loginScreen.active { display: flex !important; }
    .login-box { width: 100%; max-width: 350px; background: var(--surface); padding: 30px; border-radius: var(--radius); border: 1px solid var(--border); text-align: center; }
    .login-input { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: white; margin: 15px 0; font-size: 16px; }

    /* ===== Admin Table ===== */
    .admin-wrap { padding: 16px; max-width: 1000px; margin: 0 auto; }
    .toolbar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
    .table-responsive { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); background: var(--surface); font-size: 13px; }
    th { color: var(--muted); font-size: 11px; text-transform: uppercase; background: var(--card); }

    /* Modal Form */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; align-items: flex-end; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--surface); width: 100%; max-width: 600px;
      border-radius: 20px 20px 0 0; border-top: 1px solid var(--border);
      padding: 24px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s;
    }
    @media(min-width: 600px) { .modal { align-items: center; } .modal-content { border-radius: var(--radius); } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    input[type="text"], input[type="number"] { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); color: white; border-radius: 8px; margin-bottom: 12px; }
    label { font-size: 12px; color: var(--muted); margin-bottom: 4px; display: block; }

  </style>
</head>
<body>

  <div id="publicInterface">
    <header>
      <div class="header-inner">
        <div class="logo">LE BARA 2025</div>
        <button id="btnOpenLogin" class="btn small">üîí Admin</button>
      </div>
    </header>

    <nav class="category-nav" id="categoryNav">
      <button class="cat-pill active" data-cat="all">Tout</button>
      </nav>

    <main class="shop-container">
      <div id="shopGrid" class="shop-grid">
        <div style="grid-column: 1/-1; text-align: center; color: var(--muted); padding: 40px;">
          Chargement...
        </div>
      </div>
    </main>
  </div>


  <div id="loginScreen">
    <div class="login-box">
      <h2 style="margin:0 0 10px;">Administration</h2>
      <p style="color:var(--muted); font-size:13px; margin-bottom:20px;">Entrez le code pour g√©rer le stock.</p>
      <form id="loginForm">
        <input type="password" id="accessCode" class="login-input" placeholder="Code secret" autocomplete="off" required>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <button type="button" id="btnCancelLogin" class="btn">Retour</button>
          <button type="submit" class="btn primary">Connexion</button>
        </div>
      </form>
    </div>
  </div>


  <div id="adminInterface">
    <header>
      <div class="header-inner">
        <div class="logo">ADMIN PANEL</div>
        <div style="display:flex; gap:8px;">
          <button id="btnBackToShop" class="btn small">üëÅÔ∏è Boutique</button>
          <button id="btnLogout" class="btn small danger">D√©co</button>
        </div>
      </div>
    </header>

    <main class="admin-wrap">
      <div class="toolbar">
        <button id="btnAddProduct" class="btn primary">+ Nouveau</button>
        <button id="btnSave" class="btn success">üíæ Sauvegarder</button>
        <button id="btnImport" class="btn">üìÇ Importer</button>
        <input type="file" id="fileImport" style="display:none" accept=".json">
      </div>

      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Img</th>
              <th>Nom</th>
              <th>Cat</th>
              <th>Prix</th>
              <th>√âtat</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="adminTableBody"></tbody>
        </table>
      </div>

      <details style="margin-top:20px;">
        <summary style="color:var(--muted); cursor:pointer;">JSON Brut</summary>
        <textarea id="jsonArea" readonly style="width:100%; height:150px; background:#000; color:#0f0; border:none; margin-top:10px; font-family:monospace; font-size:11px;"></textarea>
      </details>
    </main>
  </div>


  <div id="productModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle" style="margin-top:0">Produit</h3>
      <form id="productForm">
        <label>Nom du produit</label>
        <input type="text" id="pName" required placeholder="Ex: Amnesia Haze">

        <label>Cat√©gorie (pour les filtres)</label>
        <input type="text" id="pCat" required placeholder="Ex: Fleurs">

        <label>Producteur / Ferme</label>
        <input type="text" id="pFarm" placeholder="Ex: Green House">

        <label>Prix (‚Ç¨)</label>
        <input type="number" step="0.01" id="pPrice" placeholder="0.00">

        <label>Image (URL)</label>
        <input type="text" id="pImg" placeholder="https://...">

        <div style="margin: 15px 0;">
          <label style="display:flex; align-items:center; gap:10px; font-size:14px; color:#fff;">
            <input type="checkbox" id="pAvailable" style="width:auto;"> Visible sur la boutique
          </label>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
          <button type="button" class="btn" id="modalClose" style="flex:1">Annuler</button>
          <button type="submit" class="btn primary" style="flex:1">Valider</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    // ===== CONFIGURATION =====
    const ACCESS_CODE = 'admin2024'; // V√©rifiez que c'est bien ce code que vous tapez

    // √âtat de l'application
    let state = {
      products: [],
      editingId: null,
      activeCategory: 'all'
    };

    // DOM Elements - On les s√©curise au chargement
    let views = {};

    // ===== D√âMARRAGE =====
    window.addEventListener('DOMContentLoaded', () => {
      // On r√©cup√®re les √©l√©ments une fois la page charg√©e
      views = {
        public: document.getElementById('publicInterface'),
        admin: document.getElementById('adminInterface'),
        login: document.getElementById('loginScreen')
      };

      loadCatalog();
      // On force la vue publique au d√©marrage
      switchView('public');
    });

    // ===== NAVIGATION & VUES (Fonction Corrig√©e) =====
    function switchView(viewName) {
      if (!views.public || !views.admin || !views.login) return;

      // 1. On masque tout proprement
      views.public.classList.remove('view-active');
      views.admin.classList.remove('view-active');

      // 2. On ferme le login de force
      views.login.classList.remove('active');
      views.login.style.display = ''; // Nettoyage de style inline au cas o√π

      // 3. On affiche la vue demand√©e
      if (viewName === 'public') {
        views.public.classList.add('view-active');
      }
      else if (viewName === 'admin') {
        views.admin.classList.add('view-active');
      }
      else if (viewName === 'login') {
        // Pour le login, on garde le fond 'public' visible derri√®re
        views.public.classList.add('view-active');
        views.login.classList.add('active');
      }
    }

    // ===== GESTION LOGIN (Corrig√©) =====
    document.getElementById('btnOpenLogin').addEventListener('click', () => switchView('login'));

    document.getElementById('btnCancelLogin').addEventListener('click', (e) => {
      e.preventDefault(); // Emp√™che rechargement
      switchView('public');
    });

    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault(); // CRUCIAL : Emp√™che le rechargement de la page

      const input = document.getElementById('accessCode');
      const val = input.value.trim(); // .trim() enl√®ve les espaces accidentels

      if (val === ACCESS_CODE) {
        input.value = ''; // Vider le champ
        try {
          switchView('admin'); // Changer la vue
          renderAdminTable();  // Mettre √† jour le tableau
        } catch (err) {
          console.error("Erreur lors du passage √† l'admin:", err);
          alert("Une erreur est survenue, v√©rifiez la console.");
        }
      } else {
        alert('‚ùå Code incorrect ! Essayez: admin2024');
      }
    });

    // D√©connexion
    document.getElementById('btnLogout').addEventListener('click', () => switchView('public'));

    document.getElementById('btnBackToShop').addEventListener('click', () => {
      renderPublicShop(); // Rafraichir la boutique
      switchView('public');
    });

    // ===== LOGIQUE DATA =====
    async function loadCatalog() {
      try {
        const res = await fetch('catalog.json');
        if (res.ok) {
          const data = await res.json();
          if (Array.isArray(data.products)) {
            state.products = data.products;
          }
        }
      } catch (e) {
        console.log('Mode d√©mo (pas de fichier catalog.json d√©tect√©)');
      }
      renderPublicShop();
    }

    // Sauvegarde & Import
    document.getElementById('btnSave').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify({products: state.products}, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'catalog.json';
      a.click();
    });

    document.getElementById('btnImport').addEventListener('click', () => document.getElementById('fileImport').click());
    document.getElementById('fileImport').addEventListener('change', async (e) => {
      if(!e.target.files[0]) return;
      try {
        const text = await e.target.files[0].text();
        const json = JSON.parse(text);
        state.products = json.products || [];
        renderAdminTable();
        alert('‚úÖ Import r√©ussi !');
      } catch(err) { alert('‚ùå Erreur fichier JSON'); }
    });

    // ===== RENDU BOUTIQUE =====
    function renderPublicShop() {
      const categories = ['all', ...new Set(state.products.map(p => p.category).filter(Boolean))];
      const nav = document.getElementById('categoryNav');

      if(nav) {
        nav.innerHTML = categories.map(cat => {
          const label = cat === 'all' ? 'Tout' : cat;
          const activeClass = state.activeCategory === cat ? 'active' : '';
          return `<button class="cat-pill ${activeClass}" onclick="setCategory('${cat}')">${label}</button>`;
        }).join('');
      }

      let visibleProducts = state.products.filter(p => p.available !== false);
      if (state.activeCategory !== 'all') {
        visibleProducts = visibleProducts.filter(p => p.category === state.activeCategory);
      }

      const grid = document.getElementById('shopGrid');
      if (!grid) return;

      if (visibleProducts.length === 0) {
        grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--muted)">Aucun produit disponible.</div>`;
        return;
      }

      grid.innerHTML = visibleProducts.map(p => {
        const img = (p.media && p.media[0]) ? (p.media[0].src || p.media[0].thumb) : 'https://placehold.co/400x400/222/fff?text=No+Image';
        return `
          <div class="shop-card">
            <div class="card-media"><img src="${img}" loading="lazy" style="width:100%;height:100%;object-fit:cover;"></div>
            <div class="card-info">
              <span class="card-cat">${p.category}</span>
              <h3 class="card-title">${p.name}</h3>
              ${p.farm ? `<div class="card-farm">üåø ${p.farm}</div>` : ''}
              <div class="card-price">${p.price ? Number(p.price).toFixed(2) + ' ‚Ç¨' : '-'}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    window.setCategory = (cat) => {
      state.activeCategory = cat;
      renderPublicShop();
    };

    // ===== RENDU ADMIN =====
    function renderAdminTable() {
      const tbody = document.getElementById('adminTableBody');
      const jsonArea = document.getElementById('jsonArea');

      if(jsonArea) jsonArea.value = JSON.stringify({products: state.products}, null, 2);
      if(!tbody) return;

      if(state.products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Aucun produit. Cliquez sur "+ Nouveau".</td></tr>';
        return;
      }

      tbody.innerHTML = state.products.map((p, index) => {
        const img = (p.media && p.media[0]) ? (p.media[0].src || p.media[0].thumb) : '';
        const status = p.available !== false
          ? '<span style="color:var(--success); font-weight:bold">Actif</span>'
          : '<span style="color:var(--warning)">Masqu√©</span>';

        return `
          <tr>
            <td>${img ? `<img src="${img}" style="width:32px;height:32px;border-radius:4px;object-fit:cover">` : '<span style="font-size:10px">No img</span>'}</td>
            <td><strong>${p.name}</strong></td>
            <td>${p.category}</td>
            <td>${p.price || '-'}</td>
            <td>${status}</td>
            <td style="white-space:nowrap">
              <button class="btn small" onclick="editProduct(${index})">‚úèÔ∏è</button>
              <button class="btn small danger" onclick="deleteProduct(${index})">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ===== √âDITION / AJOUT =====
    const modal = document.getElementById('productModal');
    const form = document.getElementById('productForm');

    window.editProduct = (idx) => {
      state.editingId = idx;
      const p = state.products[idx];
      document.getElementById('modalTitle').innerText = 'Modifier Produit';
      document.getElementById('pName').value = p.name || '';
      document.getElementById('pCat').value = p.category || '';
      document.getElementById('pFarm').value = p.farm || '';
      document.getElementById('pPrice').value = p.price || '';
      document.getElementById('pImg').value = (p.media && p.media[0]) ? p.media[0].src : '';
      document.getElementById('pAvailable').checked = p.available !== false;
      modal.classList.add('active');
    };

    window.deleteProduct = (idx) => {
      if(confirm('√ätes-vous s√ªr de vouloir supprimer ce produit ?')) {
        state.products.splice(idx, 1);
        renderAdminTable();
      }
    };

    if(document.getElementById('btnAddProduct')) {
      document.getElementById('btnAddProduct').addEventListener('click', () => {
        state.editingId = null;
        document.getElementById('modalTitle').innerText = 'Ajouter un Produit';
        form.reset();
        document.getElementById('pAvailable').checked = true;
        modal.classList.add('active');
      });
    }

    document.getElementById('modalClose').addEventListener('click', () => modal.classList.remove('active'));

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const priceVal = document.getElementById('pPrice').value;

      const p = {
        id: state.editingId !== null ? state.products[state.editingId].id : Date.now().toString(),
        name: document.getElementById('pName').value,
        category: document.getElementById('pCat').value,
        farm: document.getElementById('pFarm').value,
        price: priceVal ? parseFloat(priceVal) : null,
        available: document.getElementById('pAvailable').checked,
        media: []
      };

      const imgVal = document.getElementById('pImg').value;
      if(imgVal) {
        p.media.push({ type:'image', src: imgVal });
      }

      if(state.editingId !== null) {
        state.products[state.editingId] = p;
      } else {
        state.products.push(p);
      }

      modal.classList.remove('active');
      renderAdminTable();
      renderPublicShop(); // Mettre √† jour la boutique aussi
    });

  </script>
</body>
</html>