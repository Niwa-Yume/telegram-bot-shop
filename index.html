<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>CBD Shop ¬∑ Catalogue</title>
  <style>
    /* ===== Design System ===== */
    :root{
      --bg:#0a0a0f; --surface:#12131a; --surface-hover:#181925; --card:#15161f;
      --text:#f8f9fa; --muted:#8b92a7; --border:#1e1f2e;
      --accent:#24cfff; --accent-alt:#0079ff;
      --accent-grad:linear-gradient(135deg,var(--accent) 0%,var(--accent-alt) 100%);
      --success:#4ade80; --warning:#fbbf24; --danger:#f87171;
      --radius:12px;
    }

    /* Base Reset */
    *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      background: var(--bg); color: var(--text);
      font: 14px/1.5 -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0; min-height: 100vh; padding-bottom: 20px;
    }

    /* ===== Layout Views ===== */
    #publicInterface, #adminInterface, #loginScreen { display: none; }
    .view-active { display: block !important; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ===== Header Global ===== */
    header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(18, 19, 26, 0.95);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .header-inner {
      padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
      max-width: 1000px; margin: 0 auto;
    }
    .logo { font-size: 18px; font-weight: 800; background: var(--accent-grad); -webkit-background-clip: text; color: transparent; }

    /* ===== Mobile Nav / Filters (SCROLLABLE) ===== */
    .category-nav {
      position: sticky; top: 53px; z-index: 90;
      background: rgba(10, 10, 15, 0.95);
      border-bottom: 1px solid var(--border);
      padding: 10px 16px; display: flex; gap: 10px;
      overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none;
    }
    .category-nav::-webkit-scrollbar { display: none; }

    .cat-pill {
      flex-shrink: 0; padding: 6px 16px; border-radius: 20px;
      border: 1px solid var(--border); background: var(--card); color: var(--muted);
      font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s;
    }
    .cat-pill.active {
      background: var(--accent); color: #fff; border-color: var(--accent);
      box-shadow: 0 2px 10px rgba(36, 207, 255, 0.3);
    }

    /* ===== Shop Grid ===== */
    .shop-container { max-width: 1000px; margin: 0 auto; padding: 16px; }
    .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (min-width: 600px) { .shop-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; } }

    .shop-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); overflow: hidden; display: flex; flex-direction: column;
      cursor: pointer; /* Indique qu'on peut cliquer */
      transition: transform 0.2s;
    }
    .shop-card:active { transform: scale(0.98); }
    .card-media { aspect-ratio: 1; background: #000; position: relative; overflow: hidden; }
    .card-media img { width: 100%; height: 100%; object-fit: cover; }
    .card-info { padding: 12px; flex: 1; display: flex; flex-direction: column; }
    .card-cat { font-size: 10px; text-transform: uppercase; color: var(--accent); font-weight: 700; margin-bottom: 4px; }
    .card-title { font-size: 14px; margin: 0 0 4px; font-weight: 600; line-height: 1.3; }
    .card-desc { font-size: 11px; color: var(--muted); margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .card-price { margin-top: auto; font-size: 15px; font-weight: 700; color: #fff; }

    /* ===== Buttons & Inputs ===== */
    .btn {
      padding: 8px 14px; border: 1px solid var(--border); border-radius: 8px;
      background: var(--card); color: white; font-size: 13px; font-weight: 600;
      cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn.danger { background: rgba(248, 113, 113, 0.2); border-color: var(--danger); color: var(--danger); }
    .btn.small { padding: 6px 10px; font-size: 12px; }

    /* ===== Login ===== */
    #loginScreen {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000;
      display: none; align-items: center; justify-content: center; padding: 20px;
    }
    #loginScreen.active { display: flex !important; }
    .login-box { width: 100%; max-width: 350px; background: var(--surface); padding: 30px; border-radius: var(--radius); border: 1px solid var(--border); text-align: center; }
    .login-input { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: white; margin: 15px 0; font-size: 16px; }

    /* ===== Admin Table ===== */
    .admin-wrap { padding: 16px; max-width: 1000px; margin: 0 auto; }
    .toolbar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
    .table-responsive { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); background: var(--surface); font-size: 13px; }
    th { color: var(--muted); font-size: 11px; text-transform: uppercase; background: var(--card); }

    /* ===== Modals (Edit & View) ===== */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; align-items: flex-end; justify-content: center; backdrop-filter: blur(5px); }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--surface); width: 100%; max-width: 600px;
      border-radius: 20px 20px 0 0; border-top: 1px solid var(--border);
      padding: 24px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s;
      position: relative;
    }
    @media(min-width: 600px) { .modal { align-items: center; } .modal-content { border-radius: var(--radius); } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* Styles sp√©cifiques formulaires */
    input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); color: white; border-radius: 8px; margin-bottom: 12px; font-family: inherit; }
    textarea { min-height: 80px; resize: vertical; }
    label { font-size: 12px; color: var(--accent); margin-bottom: 4px; display: block; font-weight: 600; }
    .img-preview { width: 100%; height: 150px; background: #000; border-radius: 8px; margin-bottom: 12px; object-fit: contain; border: 1px dashed var(--border); display: none; }
    .img-preview.show { display: block; }

    /* Styles sp√©cifiques Fiche Produit (View) */
    .detail-img { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: var(--radius); margin-bottom: 20px; }
    .detail-cat { display: inline-block; padding: 4px 10px; border-radius: 20px; background: rgba(36, 207, 255, 0.15); color: var(--accent); font-size: 12px; font-weight: 700; margin-bottom: 10px; }
    .detail-title { font-size: 24px; margin: 0 0 8px 0; line-height: 1.2; }
    .detail-farm { font-size: 14px; color: var(--muted); margin-bottom: 20px; display: flex; align-items: center; gap: 6px; }
    .detail-desc { font-size: 15px; line-height: 1.6; color: #d1d5db; white-space: pre-wrap; margin-bottom: 24px; }
    .detail-price { font-size: 28px; font-weight: 800; color: #fff; }
    .close-modal-btn { position: absolute; top: 15px; right: 15px; background: var(--card); border: 1px solid var(--border); color: #fff; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; z-index: 10; }

  </style>
</head>
<body>

  <div id="publicInterface">
    <header>
      <div class="header-inner">
        <div class="logo">LE BARA 2025</div>
        <button id="btnOpenLogin" class="btn small">üîí Admin</button>
      </div>
    </header>

    <nav class="category-nav" id="categoryNav">
      </nav>

    <main class="shop-container">
      <div id="shopGrid" class="shop-grid">
        <div style="grid-column: 1/-1; text-align: center; color: var(--muted); padding: 40px;">Chargement...</div>
      </div>
    </main>
  </div>

  <div id="viewProductModal" class="modal">
    <div class="modal-content">
      <button class="close-modal-btn" id="btnCloseView">√ó</button>

      <img id="viewImg" class="detail-img" src="" alt="">

      <div>
        <span id="viewCat" class="detail-cat">CAT√âGORIE</span>
        <h2 id="viewName" class="detail-title">Nom du produit</h2>
        <div id="viewFarm" class="detail-farm">üåø Ferme</div>
      </div>

      <div id="viewPrice" class="detail-price">0.00 ‚Ç¨</div>

      <hr style="border:0; border-top:1px solid var(--border); margin: 20px 0;">

      <div style="color:var(--muted); font-size:12px; margin-bottom:8px; text-transform:uppercase; letter-spacing:1px;">Description</div>
      <div id="viewDesc" class="detail-desc">
        Description compl√®te ici...
      </div>

      <button class="btn primary" style="width:100%; padding: 14px; font-size:16px;" onclick="document.getElementById('btnCloseView').click()">Fermer</button>
    </div>
  </div>

  <div id="loginScreen">
    <div class="login-box">
      <h2 style="margin:0 0 10px;">Administration</h2>
      <p style="color:var(--muted); font-size:13px; margin-bottom:20px;">Code secret requis</p>
      <form id="loginForm">
        <input type="password" id="accessCode" class="login-input" placeholder="Code..." autocomplete="off" required>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <button type="button" id="btnCancelLogin" class="btn">Retour</button>
          <button type="submit" class="btn primary">Entrer</button>
        </div>
      </form>
    </div>
  </div>

  <div id="adminInterface">
    <header>
      <div class="header-inner">
        <div class="logo">ADMIN PANEL</div>
        <div style="display:flex; gap:8px;">
          <button id="btnBackToShop" class="btn small">üëÅÔ∏è Boutique</button>
          <button id="btnLogout" class="btn small danger">D√©co</button>
        </div>
      </div>
    </header>

    <main class="admin-wrap">
      <div class="toolbar">
        <button id="btnAddProduct" class="btn primary">+ Nouveau Produit</button>
        <button id="btnSave" class="btn success">üíæ Sauvegarder</button>
        <button id="btnImport" class="btn">üìÇ Importer</button>
        <input type="file" id="fileImport" style="display:none" accept=".json">
      </div>

      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Img</th>
              <th>Produit</th>
              <th>Cat√©gorie</th>
              <th>Prix</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="adminTableBody"></tbody>
        </table>
      </div>

      <details style="margin-top:20px;">
        <summary style="color:var(--muted); cursor:pointer;">JSON (Debug)</summary>
        <textarea id="jsonArea" readonly style="width:100%; height:100px; background:#000; font-size:10px;"></textarea>
      </details>
    </main>
  </div>

  <div id="productModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle" style="margin-top:0">Produit</h3>
      <form id="productForm">

        <label>Image du produit (Cliquez pour ajouter)</label>
        <img id="previewImg" class="img-preview" alt="Aper√ßu">
        <input type="file" id="pFile" accept="image/*" style="margin-bottom: 20px;">
        <input type="hidden" id="pBase64">

        <label>Nom</label>
        <input type="text" id="pName" required placeholder="Ex: Amnesia Haze">

        <label>Cat√©gorie</label>
        <input type="text" id="pCat" required placeholder="Ex: Fleurs, R√©sines...">

        <label>Description</label>
        <textarea id="pDesc" placeholder="Description d√©taill√©e du produit..."></textarea>

        <label>Ferme / Producteur</label>
        <input type="text" id="pFarm" placeholder="Ex: Green House">

        <label>Prix (‚Ç¨)</label>
        <input type="number" step="0.01" id="pPrice" placeholder="0.00">

        <label style="display:flex; align-items:center; gap:10px; color:#fff; margin-top:10px;">
          <input type="checkbox" id="pAvailable" style="width:auto; margin:0;"> Visible sur la boutique
        </label>

        <div style="display:flex; gap:10px; margin-top:20px;">
          <button type="button" class="btn" id="modalClose" style="flex:1">Annuler</button>
          <button type="submit" class="btn primary" style="flex:1">Valider</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const ACCESS_CODE = 'admin2024';

    let state = {
      products: [],
      editingId: null,
      activeCategory: 'all'
    };

    let views = {};

    // ===== D√âMARRAGE =====
    window.addEventListener('DOMContentLoaded', () => {
      views = {
        public: document.getElementById('publicInterface'),
        admin: document.getElementById('adminInterface'),
        login: document.getElementById('loginScreen')
      };
      loadCatalog();
      switchView('public');
    });

    // ===== NAVIGATION =====
    function switchView(viewName) {
      if (!views.public) return;
      views.public.classList.remove('view-active');
      views.admin.classList.remove('view-active');
      views.login.classList.remove('active');

      if (viewName === 'public') views.public.classList.add('view-active');
      else if (viewName === 'admin') views.admin.classList.add('view-active');
      else if (viewName === 'login') {
        views.public.classList.add('view-active');
        views.login.classList.add('active');
      }
    }

    document.getElementById('btnOpenLogin').addEventListener('click', () => switchView('login'));
    document.getElementById('btnCancelLogin').addEventListener('click', (e) => { e.preventDefault(); switchView('public'); });
    document.getElementById('btnLogout').addEventListener('click', () => switchView('public'));
    document.getElementById('btnBackToShop').addEventListener('click', () => { renderPublicShop(); switchView('public'); });

    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const input = document.getElementById('accessCode');
      if (input.value.trim() === ACCESS_CODE) {
        input.value = '';
        switchView('admin');
        renderAdminTable();
      } else {
        alert('‚ùå Code incorrect');
      }
    });

    // ===== DATA LOGIC =====
    async function loadCatalog() {
      try {
        const res = await fetch('catalog.json');
        if (res.ok) {
          const json = await res.json();
          state.products = json.products || [];
        }
      } catch (e) { console.log('Mode sans serveur'); }
      renderPublicShop();
    }

    // Gestion Image (File to Base64)
    document.getElementById('pFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          document.getElementById('pBase64').value = evt.target.result; // Stocke le code
          document.getElementById('previewImg').src = evt.target.result; // Affiche l'aper√ßu
          document.getElementById('previewImg').classList.add('show');
        };
        reader.readAsDataURL(file); // Encode l'image
      }
    });

    // Sauvegarder
    document.getElementById('btnSave').addEventListener('click', async () => {
      const btn = document.getElementById('btnSave');
      const originalText = btn.innerText;

      // Feedback visuel imm√©diat
      btn.innerText = '‚è≥ Sauvegarde...';
      btn.disabled = true;

      try {
        // Envoi des donn√©es au script Python server.py
        const response = await fetch('/api/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ products: state.products }) // On envoie l'√©tat actuel
        });

        if (response.ok) {
          const result = await response.json();
          alert('‚úÖ ' + result.message);

          // On met aussi √† jour le backup navigateur par s√©curit√©
          if(typeof saveToBrowser === 'function') saveToBrowser();

        } else {
          throw new Error('Le serveur a refus√© la sauvegarde');
        }
      } catch (err) {
        console.error(err);
        alert('‚ùå Erreur de connexion au serveur.\n\nAssurez-vous que le fichier "server.py" est bien lanc√© dans votre terminal !');
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    });

    // Importer
    document.getElementById('btnImport').addEventListener('click', () => document.getElementById('fileImport').click());
    document.getElementById('fileImport').addEventListener('change', async (e) => {
      if(!e.target.files[0]) return;
      const text = await e.target.files[0].text();
      state.products = JSON.parse(text).products || [];
      renderAdminTable();
      alert('Catalogue import√© !');
    });

    // ===== RENDU PUBLIC =====
    function renderPublicShop() {
      // Filtres
      const cats = ['all', ...new Set(state.products.map(p => p.category).filter(Boolean))];
      document.getElementById('categoryNav').innerHTML = cats.map(c => `
        <button class="cat-pill ${state.activeCategory === c ? 'active' : ''}" onclick="setCategory('${c}')">
          ${c === 'all' ? 'Tout' : c}
        </button>
      `).join('');

      // Grille
      let list = state.products.filter(p => p.available !== false);
      if (state.activeCategory !== 'all') list = list.filter(p => p.category === state.activeCategory);

      const grid = document.getElementById('shopGrid');
      if (list.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted)">Aucun produit ici.</div>';
        return;
      }

      grid.innerHTML = list.map((p, index) => {
        // On passe l'ID du produit √† la fonction openProductDetail
        const img = (p.media && p.media[0]) ? p.media[0].src : 'https://placehold.co/400?text=No+Img';
        // Note: on utilise p.id s'il existe, sinon l'index (moins robuste)
        return `
        <div class="shop-card" onclick="openProductDetail('${p.id || index}')">
          <div class="card-media"><img src="${img}" loading="lazy"></div>
          <div class="card-info">
            <span class="card-cat">${p.category}</span>
            <h3 class="card-title">${p.name}</h3>
            ${p.description ? `<p class="card-desc">${p.description}</p>` : ''}
            <div class="card-price">${p.price ? p.price + ' ‚Ç¨' : '-'}</div>
          </div>
        </div>`;
      }).join('');
    }

    window.setCategory = (c) => { state.activeCategory = c; renderPublicShop(); };

    // ===== VUE D√âTAIL PRODUIT =====
    const viewModal = document.getElementById('viewProductModal');

    window.openProductDetail = (idOrIndex) => {
      // Trouver le produit (soit par ID, soit par index si ancien format)
      let product = state.products.find(p => p.id == idOrIndex);
      if(!product && typeof idOrIndex === 'number') product = state.products[idOrIndex];
      if(!product) return; // S√©curit√©

      // Remplir la modale
      const img = (product.media && product.media[0]) ? product.media[0].src : 'https://placehold.co/600?text=No+Img';
      document.getElementById('viewImg').src = img;
      document.getElementById('viewCat').innerText = product.category || 'Non class√©';
      document.getElementById('viewName').innerText = product.name;
      document.getElementById('viewFarm').innerText = product.farm ? 'üåø ' + product.farm : '';
      document.getElementById('viewDesc').innerText = product.description || 'Aucune description.';
      document.getElementById('viewPrice').innerText = product.price ? product.price + ' ‚Ç¨' : 'Prix non renseign√©';

      // Afficher
      viewModal.classList.add('active');
    };

    document.getElementById('btnCloseView').addEventListener('click', () => viewModal.classList.remove('active'));

    // Fermer si on clique en dehors
    viewModal.addEventListener('click', (e) => {
      if(e.target === viewModal) viewModal.classList.remove('active');
    });

    // ===== RENDU ADMIN =====
    function renderAdminTable() {
      document.getElementById('jsonArea').value = JSON.stringify({products: state.products}, null, 2);
      const tbody = document.getElementById('adminTableBody');

      tbody.innerHTML = state.products.map((p, i) => {
        const img = (p.media && p.media[0]) ? p.media[0].src : '';
        return `
        <tr>
          <td>${img ? `<img src="${img}" style="width:32px;height:32px;border-radius:4px;object-fit:cover">` : '-'}</td>
          <td><strong>${p.name}</strong></td>
          <td>${p.category}</td>
          <td>${p.price || ''}</td>
          <td>
            <button class="btn small" onclick="editProduct(${i})">‚úèÔ∏è</button>
            <button class="btn small danger" onclick="deleteProduct(${i})">üóëÔ∏è</button>
          </td>
        </tr>`;
      }).join('');
    }

    // ===== MODAL ACTIONS (ADMIN) =====
    const modal = document.getElementById('productModal');
    const form = document.getElementById('productForm');

    window.editProduct = (i) => {
      state.editingId = i;
      const p = state.products[i];

      document.getElementById('modalTitle').innerText = 'Modifier';
      document.getElementById('pName').value = p.name || '';
      document.getElementById('pCat').value = p.category || '';
      document.getElementById('pDesc').value = p.description || '';
      document.getElementById('pFarm').value = p.farm || '';
      document.getElementById('pPrice').value = p.price || '';
      document.getElementById('pAvailable').checked = p.available !== false;

      // Image Handling
      const imgVal = (p.media && p.media[0]) ? p.media[0].src : '';
      document.getElementById('pBase64').value = imgVal;
      document.getElementById('pFile').value = ''; // Reset input file

      if(imgVal) {
        document.getElementById('previewImg').src = imgVal;
        document.getElementById('previewImg').classList.add('show');
      } else {
        document.getElementById('previewImg').classList.remove('show');
      }

      modal.classList.add('active');
    };

    window.deleteProduct = (i) => {
      if(confirm('Supprimer ?')) { state.products.splice(i, 1); renderAdminTable(); }
    };

    document.getElementById('btnAddProduct').addEventListener('click', () => {
      state.editingId = null;
      document.getElementById('modalTitle').innerText = 'Ajouter';
      form.reset();
      document.getElementById('pBase64').value = '';
      document.getElementById('previewImg').classList.remove('show');
      document.getElementById('pAvailable').checked = true;
      modal.classList.add('active');
    });

    document.getElementById('modalClose').addEventListener('click', () => modal.classList.remove('active'));

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const p = {
        id: state.editingId !== null ? state.products[state.editingId].id : Date.now().toString(),
        name: document.getElementById('pName').value,
        category: document.getElementById('pCat').value,
        description: document.getElementById('pDesc').value,
        farm: document.getElementById('pFarm').value,
        price: parseFloat(document.getElementById('pPrice').value),
        available: document.getElementById('pAvailable').checked,
        media: []
      };

      // Si une image est pr√©sente (soit nouvelle upload√©e, soit ancienne conserv√©e)
      const imgData = document.getElementById('pBase64').value;
      if(imgData) {
        p.media.push({ type: 'image', src: imgData });
      }

      if (state.editingId !== null) state.products[state.editingId] = p;
      else state.products.push(p);

      modal.classList.remove('active');
      renderAdminTable();
      renderPublicShop();
    });
  </script>
</body>
</html>